var XLOWbkCacheMgr=function(e){function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}var t={};return r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="",r(r.s=7)}([function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose",e[e.Spam=4]="Spam"}(r.LogLevel||(r.LogLevel={}))},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var o=t(0),n=t(6),i=function(){function e(){this.providers=[],this.sectionContext="__context",this.sectionBlocks="__blocks",this.sectionObjects="__objects",this.contextKey="__wbkContext",this.isValidCallback=void 0}return e.prototype.init=function(e,r,t,n,i){this.wbkId=e,this.schemaVersion=r,this.isValidCallback=n,this.logger=i,this.logger.TraceTag(0,o.LogLevel.Info,"Initializing WorkbookCacheManager workbookId: "+e+" version: "+r);var c=[this.sectionContext,this.sectionBlocks,this.sectionObjects];this.providers=t;var s=this.providers.map(function(r){return r.provider.init(e,c)});return Promise.all(s).then(function(){return!0}).catch(function(e){return i.TraceTag(0,o.LogLevel.Error,"Error initializing WorkbookCacheManager"+e.toString()),!1})},e.prototype.dispose=function(){this.providers.forEach(function(e){return e.provider.supported&&e.provider.dispose()})},Object.defineProperty(e.prototype,"workbookId",{get:function(){return this.wbkId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cacheProviders",{get:function(){return this.providers},enumerable:!0,configurable:!0}),e.prototype.saveData=function(e,r,t){var n=this,i=this.providers.map(function(o){return o.provider.supported&&o.provider.setItem(e,r,t)});return Promise.all(i).then(function(){return Promise.resolve(!0)}).catch(function(e){return n.logger.TraceTag(0,o.LogLevel.Error,"Error in saveData: "+e),Promise.resolve(!1)})},e.prototype.clearData=function(e){var r=this,t=this.providers.map(function(r){return r.provider.supported&&r.provider.removeAllItems(e)});return Promise.all(t).then(function(){return Promise.resolve(!0)}).catch(function(e){return r.logger.TraceTag(0,o.LogLevel.Error,"Error in clearData: "+e),Promise.resolve(!1)})},e.prototype.loadWorkbookFromProvider=function(e){var r=this;if(!e.provider.supported)return Promise.resolve(void 0);var t={workbookId:this.wbkId,context:void 0,blocks:[],providedBy:e.alias};return e.provider.getItem(this.sectionContext,this.contextKey).then(function(o){return o.found&&(t.context=o.result),e.provider.getAllItems(r.sectionBlocks)}).then(function(e){return e&&e.result&&(t.blocks=e.result),Promise.resolve(t)})},e.prototype.saveContext=function(e){return this.saveData(this.sectionContext,this.contextKey,e)},e.prototype.saveBlock=function(e,r){return this.saveData(this.sectionBlocks,e,r)},e.prototype.saveObject=function(e,r){return this.saveData(this.sectionObjects,e,r)},e.prototype.clearContext=function(){return this.clearData(this.sectionContext)},e.prototype.clearAllBlocks=function(){return this.clearData(this.sectionBlocks)},e.prototype.clearAllObjects=function(){return this.clearData(this.sectionObjects)},e.prototype.isDataValid=function(e,r){if(e){if(r)return r(e);if(this.isValidCallback)return this.isValidCallback(e)}return!1},e.prototype.loadWorkbook=function(e){var r=this,t=function(t,o){return r.loadWorkbookFromProvider(t).then(function(t){return r.isDataValid(t,e)?(o.stop=!0,Promise.resolve(t)):Promise.resolve(void 0)})};return n.Utils.forEachPromise(this.providers,t,{stop:!1})},e.prototype.performEviction=function(e){var r=this,t=this.providers.map(function(r){return r.provider.supported&&r.provider.performEviction(e).then(function(){return!0})});return Promise.all(t).then(function(){return Promise.resolve(!0)}).catch(function(e){return r.logger.TraceTag(0,o.LogLevel.Error,"Error in performEviction: "+e),Promise.resolve(!1)})},e}();r.WorkbookCacheManager=i},function(e,r,t){"use strict";function o(e,r){return c.IndexedDbCacheProvider.create(e,r).then(function(e){var r=[];return e.supported&&r.push({provider:e,alias:"L1"}),Promise.resolve(r)})}function n(e,r,t,n){var c=new i.WorkbookCacheManager;return o(n,r).then(function(o){return c.init(e,r,o,t,n)}).then(function(e){return e?Promise.resolve(c):Promise.resolve(void 0)}).catch(function(e){return n.TraceTag(0,s.LogLevel.Error,e),Promise.resolve(void 0)})}Object.defineProperty(r,"__esModule",{value:!0});var i=t(1),c=t(5),s=t(0),a=t(1);r.WorkbookCacheManager=a.WorkbookCacheManager,r.createWorkbookCacheManager=n},function(e,r,t){"use strict";var o=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])};return function(r,t){function o(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}();Object.defineProperty(r,"__esModule",{value:!0});var n=function(e){function r(r,t,o){var n=e.call(this,r)||this;return n.operation=t,n.name=o||"CacheError",n.message=r,n.stack=(new Error).stack,n}return o(r,e),r}(Error);n.NotSupportedErrorName="NotSupportedError",n.CacheErrorName="CacheError",n.InvalidArgumentErrorName="CacheInvalidArgumentError",n.ValidationErrorName="CacheValidationError",r.CacheError=n},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});!function(e){function r(e){for(var r=e.objectStoreNames.length-1;r>=0;r--){var t=e.objectStoreNames.item(r);null!==t&&e.deleteObjectStore(t)}}function t(e,r,t){return e?!(r&&!e.objectStoreNames.contains(r))||(t({name:"ValidationError",message:"The database doesn't contain store name:"+r}),!1):(t({name:"ValidationError",message:"The database should be initialized"}),!1)}function o(){if("indexedDB"in window&&void 0!==window.indexedDB)return window.indexedDB}function n(e,t,o,n){return new Promise(function(i,c){var s=o?e.open(t,o):e.open(t);s.onupgradeneeded=function(e){var t=e.target.result;r(t),n&&n(t)},s.onsuccess=function(e){i({db:e.target.result,dbName:t})},s.onerror=function(){c(s.error)},s.onblocked=function(e){c(e)}})}function i(e,r){return new Promise(function(t,o){var n=e.deleteDatabase(r);n.onsuccess=function(){return t()},n.onblocked=function(){t()},n.onerror=function(){o(n.error)}})}function c(e,r,o,n){return new Promise(function(i,c){if(t(e,r,c)){var s,a=e.transaction([r],o);a.oncomplete=function(){return i()},a.onerror=function(){return c(s||a.error)};var u=a.objectStore(r),h=n(u);h.onerror=function(){s=h.error}}})}function s(e,r,t,o){return c(e,r,"readwrite",function(e){return t?e.put(o,t):e.put(o)})}function a(e,r,o){return new Promise(function(n,i){if(t(e,void 0,i)){e.objectStoreNames.contains(r)||n(void 0);var c,s=e.transaction([r],"readonly");s.onerror=function(){i(c||s.error)};var a=s.objectStore(r),u=a.get(o);u.onsuccess=function(e){return n(e.target.result)},u.onerror=function(){c=u.error}}})}function u(e,r){return new Promise(function(o,n){if(t(e,r,n)){var i,c=new Array,s=e.transaction([r],"readonly");s.oncomplete=function(){return o(c)},s.onerror=function(){return n(i||s.error)};var a=s.objectStore(r),u=a.openCursor();u.onsuccess=function(e){var r=e.target.result;r&&(c.push(r.value),r.continue())},u.onerror=function(){i=u.error}}})}function h(e,r){return new Promise(function(o,n){if(t(e,r,n)){var i,c=[],s=e.transaction([r],"readonly");s.oncomplete=function(){return o(c)},s.onerror=function(){return n(i||s.error)};var a=s.objectStore(r),u=a.openCursor();u.onsuccess=function(e){var r=e.target.result;r&&(c.push(r.key),r.continue())},u.onerror=function(){i=u.error}}})}function l(e,r,t){return c(e,r,"readwrite",function(e){return e.delete(t)})}function d(e,r){return c(e,r,"readwrite",function(e){return e.clear()})}e.getDbFactory=o,e.initDb=n,e.deleteDb=i,e.doTransactionAction=c,e.put=s,e.get=a,e.getAllItems=u,e.getAllKeys=h,e.remove=l,e.removeAll=d}(r.IdbPromised||(r.IdbPromised={}))},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var o=t(0),n=t(4),i=t(3),c=function(){function e(){var e=this;this.providerSupported=!1,this.cacheInitialized=!1,this.initializing=!1,this.registerDbName="__xloCacheRegisterDb___",this.registerDbStoreName="__cachesRegister__",this.notSupportedMsg="Provider Not Supported",this.cacheCloseHandler=function(){e.cacheDb&&(e.cacheDb.removeEventListener("close",e.cacheCloseHandler),e.cacheDb.close(),e.cacheDb=void 0)};var r=n.IdbPromised.getDbFactory();r&&(this.providerSupported=!0,this.dbFactory=r)}return e.create=function(r,t){var n=new e;return n.version=t,n.logger=r,n.supported?n.initRegisterDb().then(function(e){var r=e.db.version;return e.db.close(),r}).then(function(e){return t&&e<t?n.clearAll().then(function(){return n.initRegisterDb(!0)}).then(function(e){return e.db.close(),n}):(t&&e>t&&(n.providerSupported=!1),n)}).catch(function(e){return r.TraceTag(0,o.LogLevel.Error,"Error in IndexedDbCacheProvider.create: "+e.toString()),Promise.reject(new i.CacheError(e.message,"IndexedDbCacheProvider.create",e.name))}):Promise.resolve(n)},e.prototype.initRegisterDb=function(e){var r=this;if(void 0===e&&(e=!1),!this.supported)return Promise.reject(new i.CacheError(this.notSupportedMsg,"initRegisterDb",i.CacheError.NotSupportedErrorName));var t=function(e){e.createObjectStore(r.registerDbStoreName,{autoIncrement:!1,keyPath:"id"})},o=e?this.version:void 0;return n.IdbPromised.initDb(this.dbFactory,this.registerDbName,o,t).then(function(e){return Promise.resolve(e)})},e.prototype.ensureCacheDb=function(){var e=this;if(this.cacheDb)return Promise.resolve({db:this.cacheDb,dbName:this.cacheDbName});if(!this.supported||!this.cacheInitialized&&!this.initializing)return Promise.reject(new i.CacheError(this.notSupportedMsg,"ensureCacheDb",i.CacheError.NotSupportedErrorName));var r=function(r){for(var t=0,o=e.cacheSections;t<o.length;t++){var n=o[t];r.createObjectStore(n)}};return n.IdbPromised.initDb(this.dbFactory,this.cacheDbName,this.version,r).then(function(r){return e.cacheDb=r.db,e.cacheDb.addEventListener("close",e.cacheCloseHandler),Promise.resolve(r)})},e.prototype.initCache=function(){var e=this;if(!this.supported)return Promise.reject(new i.CacheError(this.notSupportedMsg,"initCache",i.CacheError.NotSupportedErrorName));if(""===this.cacheDbName)return Promise.reject(new i.CacheError("Cache name should not be empty","initCache",i.CacheError.ValidationErrorName));if(0===this.cacheSections.length)return Promise.reject(new i.CacheError("Must provide at least one section","initCache",i.CacheError.ValidationErrorName));this.initializing=!0,this.cacheInitialized=!1;var r;return this.initRegisterDb().then(function(t){return r=t.db,e.ensureCacheDb()}).then(function(){return n.IdbPromised.get(r,e.registerDbStoreName,e.cacheDbName)}).then(function(t){var o;return t?(o=t,o.lastUsed=Date.now()):o={id:e.cacheDbName,lastUsed:Date.now()},o.data=e.cacheData,n.IdbPromised.put(r,e.registerDbStoreName,void 0,o)}).then(function(){return e.cacheInitialized=!0,e.initializing=!1,r.close(),Promise.resolve({cacheName:e.cacheDb?e.cacheDb.name:""})}).catch(function(t){return e.logger.TraceTag(0,o.LogLevel.Error,"Error in initCache: "+t.toString()),r.close(),e.initializing=!1,Promise.reject(new i.CacheError(t.message,"initCache",t.name))})},e.prototype.init=function(e,r,t){return this.closeCache(),this.cacheDbName=e,this.cacheSections=r,this.cacheData=t,this.initCache()},e.prototype.dispose=function(){this.closeCache()},e.prototype.closeCache=function(){this.cacheDb&&(this.cacheDb.removeEventListener("close",this.cacheCloseHandler),this.cacheDb.close(),this.cacheDb=void 0),this.cacheInitialized=!1},Object.defineProperty(e.prototype,"cacheName",{get:function(){return this.cacheDbName},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"providerName",{get:function(){return"IndexedDb"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"supported",{get:function(){return this.providerSupported},enumerable:!0,configurable:!0}),e.prototype.setItem=function(e,r,t){var c=this;return this.ensureCacheDb().then(function(){return n.IdbPromised.put(c.cacheDb,e,r,t)}).then(function(){return Promise.resolve(!0)}).catch(function(e){return c.logger.TraceTag(0,o.LogLevel.Error,"Error in setItem: "+e.toString()),Promise.reject(new i.CacheError(e.message,"setItem",e.name))})},e.prototype.getItem=function(e,r){var t=this;return this.ensureCacheDb().then(function(){return n.IdbPromised.get(t.cacheDb,e,r)}).then(function(t){return{key:r,section:e,result:t,found:void 0!==t}},function(){return{key:r,section:e,result:void 0,found:!1}}).catch(function(e){return t.logger.TraceTag(0,o.LogLevel.Error,"Error in getItem: "+e.toString()),Promise.reject(new i.CacheError(e.message,"getItem",e.name))})},e.prototype.getAllKeys=function(e){var r=this;return this.ensureCacheDb().then(function(){return n.IdbPromised.getAllKeys(r.cacheDb,e)}).then(function(r){return Promise.resolve({section:e,keys:r})}).catch(function(e){return r.logger.TraceTag(0,o.LogLevel.Error,"Error in getAllKeys: "+e.toString()),Promise.reject(new i.CacheError(e.message,"getAllKeys",e.name))})},e.prototype.getAllItems=function(e){var r=this;return this.ensureCacheDb().then(function(){return n.IdbPromised.getAllItems(r.cacheDb,e)}).then(function(r){return Promise.resolve({section:e,result:r})}).catch(function(e){return r.logger.TraceTag(0,o.LogLevel.Error,"Error in getAll: "+e.toString()),Promise.reject(new i.CacheError(e.message,"getAll",e.name))})},e.prototype.removeItem=function(e,r){var t=this;return this.ensureCacheDb().then(function(){return n.IdbPromised.remove(t.cacheDb,e,r)}).then(function(){return Promise.resolve({key:r,section:e})}).catch(function(e){return t.logger.TraceTag(0,o.LogLevel.Error,"Error in removeItem: "+e.toString()),Promise.reject(new i.CacheError(e.message,"removeItem",e.name))})},e.prototype.removeAllItems=function(e){var r=this;return this.ensureCacheDb().then(function(){return n.IdbPromised.removeAll(r.cacheDb,e)}).then(function(){return Promise.resolve(!0)}).catch(function(e){return r.logger.TraceTag(0,o.LogLevel.Error,"Error in removeAllItems: "+e.toString()),Promise.reject(new i.CacheError(e.message,"removeAllItems",e.name))})},e.prototype.getSections=function(){var e=this;return this.ensureCacheDb().then(function(){var r=[];if(e.cacheDb)for(var t=0;t<e.cacheDb.objectStoreNames.length;++t)r.push(e.cacheDb.objectStoreNames[t]);return Promise.resolve(r)}).catch(function(r){return e.logger.TraceTag(0,o.LogLevel.Error,"Error in getSections: "+r.toString()),Promise.reject(new i.CacheError(r.message,"getSections",r.name))})},e.prototype.getAllCaches=function(){var e,r=this;return this.initRegisterDb().then(function(t){return e=t.db,n.IdbPromised.getAllItems(e,r.registerDbStoreName)}).then(function(t){return e.close(),Promise.resolve({section:r.registerDbStoreName,result:t})}).catch(function(e){return r.logger.TraceTag(0,o.LogLevel.Error,"Error in getAllCaches: "+e.toString()),Promise.reject(new i.CacheError(e.message,"getAllCaches",e.name))})},e.prototype.deleteCache=function(e){var r,t=this;return this.initRegisterDb().then(function(o){return r=o.db,n.IdbPromised.deleteDb(t.dbFactory,e)}).then(function(){return n.IdbPromised.remove(r,t.registerDbStoreName,e)}).then(function(){return r.close(),Promise.resolve(e)}).catch(function(e){return t.logger.TraceTag(0,o.LogLevel.Error,"Error in deleteCache: "+e.toString()),Promise.reject(new i.CacheError(e.message,"deleteCache",e.name))})},e.prototype.clearAll=function(){var e=this;return this.closeCache(),this.getAllCaches().then(function(r){var t=[];return r&&r.result&&r.result.forEach(function(r){r.id&&t.push(n.IdbPromised.deleteDb(e.dbFactory,r.id))}),t.push(n.IdbPromised.deleteDb(e.dbFactory,e.registerDbName)),Promise.all(t)}).then(function(){return Promise.resolve(void 0)}).catch(function(r){return e.logger.TraceTag(0,o.LogLevel.Error,"Error in clearAll: "+r.toString()),Promise.reject(new i.CacheError(r.message,"clearAll",r.name))})},e.prototype.performEviction=function(e){var r=this;return this.getAllCaches().then(function(t){if(!t.result)return Promise.resolve([]);var o=t.result,n=o.reduce(function(t,o){return r.cacheInitialized&&o.id===r.cacheDbName||!e(o.id,o.lastUsed,o.data)||t.push(r.deleteCache(o.id)),t},[]);return Promise.all(n)}).then(function(e){return{evictedCaches:e}}).catch(function(e){return r.logger.TraceTag(0,o.LogLevel.Error,"Error in performEviction: "+e.toString()),Promise.reject(new i.CacheError(e.message,"performEviction",e.name))})},e}();r.IndexedDbCacheProvider=c},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});!function(e){function r(e,r,t){return e.reduce(function(e,o){return e.then(function(){return t&&t.stop?Promise.resolve(void 0):r(o,t)})},Promise.resolve(void 0))}e.forEachPromise=r}(r.Utils||(r.Utils={}))},function(e,r,t){e.exports=t(2)}]);
//# sourceMappingURL=workbookCacheManager.min.map